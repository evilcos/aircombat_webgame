# agents.md — 像素风网页版打飞机（竖屏 9:16 / 分支 A：爽快割草向 / 指针跟随操控）

## 1. 项目一句话
做一个竖屏 9:16 的像素风网页打飞机小游戏：**玩家飞机跟随触摸手势/鼠标移动**（更有操作感），自动射击为主，敌机不局限轨道直线下落，节奏偏“割草爽 + 少量读图躲避”，一局约 75 秒，带完整 **BGM + 音效**（必须）。

---

## 2. 目标与交付物
### 2.1 目标（必须）
- 竖屏 9:16，移动端触控与桌面端鼠标都顺手。
- 操控方式：飞机 **跟随指针/触摸** 移动（带惯性/平滑，手感更“黏”）。
- 敌机运动：包含直线/弧线/蛇形/俯冲/追踪等，不局限轨道。
- 体验偏爽：火力强、目标密度高、反馈明显。
- **音乐与音效必须**：可开关、音量可调（至少 BGM/SE 分开）。
- 单文件可运行：`index.html`（内含 CSS + JS + 音频资源或 WebAudio 合成）。

### 2.2 交付物（必须）
- `index.html`：打开即玩，无需外部依赖（可选 CDN 但不建议）。
- 结构化代码：即使单文件也要分区（Config / Entities / Systems / Audio / Render / UI）。

---

## 3. 非目标（不要做）
- 不做复杂成长系统/多周目剧情/在线排行榜（可本地最高分）。
- 不做重度物理模拟（保持像素街机手感）。

---

## 4. 视觉风格（像素 + 极简 + 反馈强）
### 4.1 像素渲染
- 逻辑画布：360×640（或 450×800），按设备缩放显示。
- `image-rendering: pixelated;` 保证像素边缘锐利。
- 用 `devicePixelRatio` 提高清晰度（逻辑坐标不变）。

### 4.2 颜色
- 2–3 色主色体系：背景深色 + 主色（玩家/子弹/分数）+ 警告色（敌弹/预警）。
- 禁止花哨渐变；用亮度变化表达状态（命中闪白、预警闪烁）。

### 4.3 必须的反馈特效
- 命中：1 帧闪白 + 6–12 粒像素碎裂粒子
- 爆炸：粒子喷射 + 轻微屏幕抖动（1–2px / 1–2 帧）
- 预警：俯冲/追踪攻击前，出现轨迹虚线或“锁定框”闪烁

---

## 5. 操作设计（替换“轨道切换”为“指针跟随”）
### 5.1 核心操作（必须）
- 移动端：按住拖动（或手指移动）=> 飞机跟随手指位置
- 桌面端：鼠标移动 => 飞机跟随鼠标位置（可选：按住左键才跟随，默认“跟随”更爽）
- 键盘可选补充（不强制）：
  - `WASD/方向键` 微调（仅作为无鼠标时的兼容）
  - `P` 暂停，`R` 重开

### 5.2 手感（必须实现平滑）
- 不是“瞬移”，而是平滑跟随（建议二选一）：
  1) **一阶低通（lerp）**：`pos += (target - pos) * follow`
  2) **速度限制**：最大速度 `maxSpeed`，逐帧逼近 target
- 推荐参数（初值）：
  - `follow=0.18`（60fps）
  - `maxSpeed=8.5 px/frame`
- 边界限制：飞机不可出屏，保留 8–12px 安全边距。

### 5.3 自动射击
- 默认自动射击（玩家只管走位）
- 允许道具增强火力（见道具系统）

---

## 6. 场景布局与 UI（竖屏）
### 6.1 UI（必须）
- 顶部左：SCORE
- 顶部中：COMBO（连击与倍率）
- 顶部下：进度条（0–75s）+ 秒数
- 顶部右：暂停按钮（像素 “||”）+ 音频开关（♪）
- 底部左：生命（♥♥♥）
- 底部右：道具状态（Spread 倒计时 / Shield 图标 / Clear 可用提示）

### 6.2 玩家位置
- 默认在底部活动区：建议限制玩家 Y 不超过 `H*0.90` 到 `H*0.35`（避免跑到屏幕最顶端导致玩法失焦）
- 推荐：玩家可在全屏移动，但在顶部 20% 区域增加“阻尼”（让玩家自然回到底部战斗区）。

---

## 7. 敌人与弹幕（不再限定“轨道直线”）
### 7.1 敌人类型（必须至少 4 类，确保运动多样）
#### E1. 小型机（主菜 / 易碎 / 多）
- 血量：1
- 分数：10
- 运动：直线下落 + 微抖动（轻微横向漂移）
- 权重：60%

#### E2. 蛇形机（制造走位）
- 血量：1
- 分数：15
- 运动：正弦横移下落（`x = x0 + A*sin(ωt + φ)`）
- 权重：18%

#### E3. 装甲机（爽感拐点）
- 血量：3
- 分数：45
- 运动：缓慢下落 + 偶尔横向漂移
- 权重：12%

#### E4. 俯冲机（紧张调味）
- 血量：1
- 分数：30
- 运动：先在上方短暂“锁定”玩家位置（预警 280ms），随后沿一条斜线高速俯冲穿越屏幕
- 权重：10%

> 说明：分支 A 的关键仍是“敌机密 + 火力强”，俯冲机别太多，主要用于刺激。

### 7.2 敌弹（可选但建议，增强上限）
- 只给部分敌人开火（例如装甲机/俯冲机），频率低，避免太乱。
- 敌弹速度略慢于玩家子弹，但带警告色与清晰判定。

---

## 8. 生成与难度曲线（75 秒一局 / 爽快割草）
### 8.1 时间分段参数表（必须可配置）
| 时间段 | 生成间隔 | 敌人基础速度 | 俯冲机比例上限 | 蛇形幅度A |
|---|---:|---:|---:|---:|
| 0–15s  | 420ms | 2.2 px/frame | 4%  | 14px |
| 15–30s | 360ms | 2.7 | 6%  | 16px |
| 30–45s | 320ms | 3.2 | 8%  | 18px |
| 45–60s | 290ms | 3.7 | 10% | 20px |
| 60–75s | 260ms | 4.1 | 12% | 22px |

### 8.2 生成规则（必须）
- 采用权重随机：E1/E2/E3/E4（按段落对 E4 上限限制）
- “同侧拥挤”缓解：连续在同一水平带生成过多时，下一次偏向另一侧（轻度平衡，避免一边空一边爆）
- 屏幕上敌人数量软上限（例如 18–24），超过后临时放宽生成间隔，保证性能与可读性。

---

## 9. 玩家火力、连击与评分（A：更爽）
### 9.1 基础射击（必须）
- 自动射击间隔：140ms
- 子弹速度：8.8 px/frame
- 子弹宽高：4×10（像素条）
- 命中即消失（默认不穿透）

### 9.2 连击与倍率（必须）
- 击毁 +1 连击；玩家受击清零
- 倍率与射速联动：
  - Combo 0–9：x1.0 / 140ms
  - Combo 10–24：x1.5 / 125ms
  - Combo 25–49：x2.0 / 115ms
  - Combo 50+：x2.5 / 105ms
- Combo ≥25：子弹加拖影（纯视觉）

### 9.3 受击与无敌（必须）
- 生命：3
- 受击：
  - HP -1
  - 连击清零
  - 无敌 1s（闪烁）
- 无敌期间仍可得分与射击

---

## 10. 道具系统（必须 3 种 + 掉落保底）
### 10.1 道具
1) **Spread（散射）**：3 发扇形，持续 6 秒  
2) **Shield（护盾）**：抵挡 1 次碰撞（消耗后碎裂特效）  
3) **Clear（清屏）**：清除屏幕敌人；清屏击毁 **不增加连击**（仍给分与倍率）

### 10.2 掉落规则（必须）
- 保底：每击毁 15 个敌人必掉 1 个道具
- 随机：每个敌人额外 6% 概率掉落
- 权重：Spread 50% / Shield 35% / Clear 15%

---

## 11. 碰撞与判定（必须：清晰可靠）
- 使用 AABB 矩形碰撞
- 碰撞盒建议：
  - 玩家：18×18
  - 敌人：16×16（装甲机可 18×18）
  - 敌弹：6×6
  - 道具：12×12（可放大拾取判定，提升爽感）
- 护盾优先：玩家有护盾时碰撞只消耗护盾并炸掉敌人。

---

## 12. 音频系统（BGM + 音效 = 必须）
### 12.1 必须功能
- **BGM**：循环播放（至少 1 首），可开关、可调音量（0–100%）
- **音效（SE）**：至少包含：
  - 射击（很轻、短、频繁但不刺耳）
  - 命中（清脆）
  - 爆炸（更重）
  - 道具拾取（清亮）
  - 受击/护盾破裂（警示）
  - UI 点击（轻）
- 音量分离：`BGM Volume` 与 `SE Volume` 分开

### 12.2 实现约束（必须考虑移动端）
- 首次用户交互（pointerdown/点击开始按钮）后再初始化/解锁音频（iOS Safari 规则）
- 两种可行实现（任选其一）：
  1) **WebAudio 合成**（推荐，完全无外部素材）：用振荡器 + ADSR 包络生成短音效；BGM 用简单 arpeggio/鼓点循环（轻量像素风很合适）
  2) **内嵌音频资源**：将 mp3/ogg base64 内嵌进 JS（单文件更重，但可接受）；需注意体积

### 12.3 音频验收
- 任何设备上：开始游戏后必能听到 BGM 与音效（用户未静音情况下）
- 频繁射击音效不能刺耳：需做 **限流/聚合**（例如每 50ms 最多触发一次“射击 tick”）

---

## 13. 数据结构与系统划分（建议）
### 13.1 Config（集中管理手感与难度）
- `BASE_W=360`, `BASE_H=640`
- `RUN_TIME=75_000`
- `FOLLOW=0.18`, `MAX_SPEED=8.5`
- `FIRE_MS_BASE=140`
- `SEGMENTS=[...]`（难度表）
- `ENEMY_CAP=22`
- `AUDIO={ bgmVol, seVol, enabled }`

### 13.2 Entities
- `Player { x,y, targetX,targetY, hp, invulnMs, shield, spreadMs, fireMs, combo, score }`
- `Bullet { x,y, vx,vy, alive }`
- `Enemy { type, x,y, vx,vy, hp, t, meta }`  
  - `t` 为生命周期时间，用于正弦/俯冲/锁定等运动
  - `meta` 存锁定点、预警剩余等
- `PowerUp { type, x,y, vy }`
- `Particle { x,y, vx,vy, lifeMs, size }`

### 13.3 Systems
- `InputSystem`：读取 pointer/mouse 位置 => 更新 `player.targetX/Y`
- `MovementSystem`：平滑跟随 + 实体运动（deltaTime）
- `SpawnerSystem`：按段落生成敌人；控制上限与权重
- `CombatSystem`：碰撞、伤害、掉落、清屏逻辑
- `ScoreSystem`：连击、倍率、结算统计
- `AudioSystem`：BGM/SE 播放与限流、设置 UI
- `RenderSystem`：像素绘制（实体、粒子、UI）
- `StateMachine`：`MENU -> PLAYING -> PAUSED -> GAMEOVER`

---

## 14. 游戏状态与流程（必须）
- MENU：显示标题、开始按钮、音量滑条（BGM/SE）
- PLAYING：正常游戏
- PAUSED：冻结更新（音频 BGM 可降音量或暂停）
- GAMEOVER：显示结果 + 最高分（localStorage）+ 重开按钮

---

## 15. 验收标准（必须全部通过）
1) 玩家飞机能跟随手指/鼠标平滑移动，边界限制正确，手感不“飘”。
2) 敌机运动包含至少：直线 + 蛇形 + 俯冲锁定（且预警清晰）。
3) 游戏节奏爽：屏幕常有可打目标，连击上升明显增强火力与得分。
4) BGM 与音效必定可用：开始后可听到；支持开关与音量；射击音效做限流不刺耳。
5) 75 秒难度递增：0–15s爽，30s后开始紧张，60–75s压迫感强但可凭走位活下来。
6) 单文件 `index.html` 可离线打开游玩，无外部依赖也能完整运行。

---

## 16. 开发顺序（建议）
1) Canvas 自适配 + 像素渲染
2) 指针跟随移动（平滑）+ 边界限制
3) 自动射击 + 子弹系统
4) 敌人系统：直线/蛇形/装甲/俯冲
5) 碰撞/生命/无敌
6) 分数/连击/倍率 + UI
7) 道具与掉落保底（Spread/Shield/Clear）
8) 音频系统（先解锁后播放）+ 音量 UI + 限流
9) 粒子/震动/预警等反馈完善
10) 结算页 + localStorage 最高分

---

## 17. 三个关键“手感旋钮”（必须写进 Config）
- `spawnIntervalMs`（密度）
- `follow/maxSpeed`（操作感：黏/飘）
- `enemyBaseSpeed`（压力）
调参策略：
- 太乱：`spawnInterval +60ms` 或 `ENEMY_CAP -2`
- 不爽：`FIRE_MS -10ms` 或 增加 Spread 掉落权重
- 太轻松：`enemySpeed +0.3` 或 提高俯冲机上限 2%
